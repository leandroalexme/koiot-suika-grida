(function(g,S){typeof exports=="object"&&typeof module<"u"?S(exports):typeof define=="function"&&define.amd?define(["exports"],S):(g=typeof globalThis<"u"?globalThis:g||self,S(g.KoiotCore={}))})(this,function(g){"use strict";function S(r,t){return{x:Math.min(r.x,t.x),y:Math.min(r.y,t.y),width:Math.abs(r.x-t.x),height:Math.abs(r.y-t.y)}}function gt(r,t){return r.x<=t.x+t.width&&r.x+r.width>=t.x&&r.y<=t.y+t.height&&r.y+r.height>=t.y}let v=class{constructor(){this.listeners=new Map}on(t,e){this.listeners.has(t)||this.listeners.set(t,new Set),this.listeners.get(t).add(e)}off(t,e){const s=this.listeners.get(t);s&&(s.delete(e),s.size===0&&this.listeners.delete(t))}emit(t,...e){const s=this.listeners.get(t);s&&s.forEach(i=>{try{i(...e)}catch(n){console.error(`Error in event listener for "${String(t)}":`,n)}})}removeAllListeners(){this.listeners.clear()}};function ft(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(r){const t=Math.random()*16|0;return(r==="x"?t:t&3|8).toString(16)})}function D(){return window.devicePixelRatio||1}function Y(r){let t=null,e;return(...s)=>{e=s,t===null&&(t=requestAnimationFrame(()=>{r(...e),t=null}))}}function ut(r,t,e){return Math.min(Math.max(r,t),e)}function mt(r,t,e,s,i){return{x:(r-s)*e,y:(t-i)*e}}function X(r,t,e,s,i){return{x:r/e+s,y:t/e+i}}class _{constructor(t,e){this._fillStyle="#000000",this._strokeStyle="#000000",this._globalAlpha=1,this._lineWidth=1,this.currentPath=null,this.stateStack=[],this.canvasKit=t,this.surface=e,this.canvas=e.getCanvas(),this.fillPaint=new t.Paint,this.fillPaint.setStyle(t.PaintStyle.Fill),this.fillPaint.setAntiAlias(!0),this.strokePaint=new t.Paint,this.strokePaint.setStyle(t.PaintStyle.Stroke),this.strokePaint.setAntiAlias(!0),this.updateFillColor(),this.updateStrokeColor(),this.updateStrokeWidth()}parseColor(t){if(t.startsWith("#")&&t.length===7){const s=t.slice(1),i=parseInt(s.slice(0,2),16)/255,n=parseInt(s.slice(2,4),16)/255,o=parseInt(s.slice(4,6),16)/255,a=this._globalAlpha;return this.canvasKit.Color4f(i,n,o,a)}if(t.startsWith("rgba(")){const s=t.match(/rgba\((\d+),\s*(\d+),\s*(\d+),\s*([\d.]+)\)/);if(s){const i=parseInt(s[1],10)/255,n=parseInt(s[2],10)/255,o=parseInt(s[3],10)/255,a=parseFloat(s[4]);return this.canvasKit.Color4f(i,n,o,a)}}if(t.startsWith("rgb(")){const s=t.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);if(s){const i=parseInt(s[1],10)/255,n=parseInt(s[2],10)/255,o=parseInt(s[3],10)/255,a=this._globalAlpha;return this.canvasKit.Color4f(i,n,o,a)}}if(t.startsWith("#")&&t.length===4){const s=t.slice(1),i=parseInt(s[0]+s[0],16)/255,n=parseInt(s[1]+s[1],16)/255,o=parseInt(s[2]+s[2],16)/255,a=this._globalAlpha;return this.canvasKit.Color4f(i,n,o,a)}const e={black:[0,0,0],white:[1,1,1],red:[1,0,0],green:[0,.5,0],blue:[0,0,1],yellow:[1,1,0],cyan:[0,1,1],magenta:[1,0,1],transparent:[0,0,0]};if(e[t.toLowerCase()]){const[s,i,n]=e[t.toLowerCase()],o=t.toLowerCase()==="transparent"?0:this._globalAlpha;return this.canvasKit.Color4f(s,i,n,o)}return this.canvasKit.Color4f(0,0,0,this._globalAlpha)}updateFillColor(){const t=this.parseColor(this._fillStyle);this.fillPaint.setColor(t)}updateStrokeColor(){const t=this.parseColor(this._strokeStyle);this.strokePaint.setColor(t)}updateStrokeWidth(){this.strokePaint.setStrokeWidth(this._lineWidth)}save(){this.canvas.save(),this.stateStack.push({fillStyle:this._fillStyle,strokeStyle:this._strokeStyle,globalAlpha:this._globalAlpha,lineWidth:this._lineWidth})}restore(){this.canvas.restore();const t=this.stateStack.pop();t&&(this._fillStyle=t.fillStyle,this._strokeStyle=t.strokeStyle,this._globalAlpha=t.globalAlpha,this._lineWidth=t.lineWidth,this.updateFillColor(),this.updateStrokeColor(),this.updateStrokeWidth())}setTransform(t,e,s,i,n,o){const a=[t,s,n,e,i,o,0,0,1];this.canvas.concat(a)}translate(t,e){this.canvas.translate(t,e)}scale(t,e){this.canvas.scale(t,e)}rotate(t){this.canvas.rotate(t*180/Math.PI,0,0)}fillRect(t,e,s,i){const n=this.canvasKit.XYWHRect(t,e,s,i);this.canvas.drawRect(n,this.fillPaint)}strokeRect(t,e,s,i){const n=this.canvasKit.XYWHRect(t,e,s,i);this.canvas.drawRect(n,this.strokePaint)}clearRect(t,e,s,i){this.save();const n=new this.canvasKit.Paint;n.setBlendMode(this.canvasKit.BlendMode.Clear);const o=this.canvasKit.XYWHRect(t,e,s,i);this.canvas.drawRect(o,n),n.delete(),this.restore()}beginPath(){this.currentPath&&this.currentPath.delete(),this.currentPath=new this.canvasKit.Path}moveTo(t,e){this.currentPath||this.beginPath(),this.currentPath.moveTo(t,e)}lineTo(t,e){this.currentPath||this.beginPath(),this.currentPath.lineTo(t,e)}rect(t,e,s,i){this.currentPath||this.beginPath();const n=this.canvasKit.XYWHRect(t,e,s,i);this.currentPath.addRect(n)}fill(){this.currentPath&&this.canvas.drawPath(this.currentPath,this.fillPaint)}stroke(){this.currentPath&&this.canvas.drawPath(this.currentPath,this.strokePaint)}clearBackground(t,e,s){this.canvas.clear(this.canvasKit.WHITE)}flush(){this.surface.flush()}get fillStyle(){return this._fillStyle}set fillStyle(t){this._fillStyle=t,this.updateFillColor()}get strokeStyle(){return this._strokeStyle}set strokeStyle(t){this._strokeStyle=t,this.updateStrokeColor()}get lineWidth(){return this._lineWidth}set lineWidth(t){this._lineWidth=t,this.updateStrokeWidth()}get globalAlpha(){return this._globalAlpha}set globalAlpha(t){this._globalAlpha=t,this.updateFillColor(),this.updateStrokeColor()}destroy(){this.currentPath&&(this.currentPath.delete(),this.currentPath=null),this.fillPaint.delete(),this.strokePaint.delete()}}const H=class H{static async initCanvasKit(t){if(this.canvasKit)return this.canvasKit;const e=(await import("canvaskit-wasm")).default;return this.canvasKit=await e({locateFile:(t==null?void 0:t.locateFile)||(s=>`https://unpkg.com/canvaskit-wasm@0.39.1/bin/${s}`)}),this.canvasKit}static async createRenderer(t,e){const s=await this.initCanvasKit(e);t.id||(t.id="koiot-canvas");const i=s.MakeCanvasSurface(t.id);if(!i)throw new Error("Failed to create CanvasKit surface");return new _(s,i)}};H.canvasKit=null;let P=H;class F{constructor(t){this.stateStack=[];const e=t.getContext("2d");if(!e)throw new Error("Failed to get 2D rendering context");this.ctx=e}save(){this.ctx.save()}restore(){this.ctx.restore()}setTransform(t,e,s,i,n,o){this.ctx.setTransform(t,e,s,i,n,o)}translate(t,e){this.ctx.translate(t,e)}scale(t,e){this.ctx.scale(t,e)}rotate(t){this.ctx.rotate(t)}fillRect(t,e,s,i){this.ctx.fillRect(t,e,s,i)}strokeRect(t,e,s,i){this.ctx.strokeRect(t,e,s,i)}clearRect(t,e,s,i){this.ctx.clearRect(t,e,s,i)}beginPath(){this.ctx.beginPath()}moveTo(t,e){this.ctx.moveTo(t,e)}lineTo(t,e){this.ctx.lineTo(t,e)}rect(t,e,s,i){this.ctx.rect(t,e,s,i)}fill(){this.ctx.fill()}stroke(){this.ctx.stroke()}clearBackground(t,e,s){this.ctx.save(),this.ctx.fillStyle=t,this.ctx.fillRect(0,0,e,s),this.ctx.restore()}flush(){}get fillStyle(){return this.ctx.fillStyle}set fillStyle(t){this.ctx.fillStyle=t}get strokeStyle(){return this.ctx.strokeStyle}set strokeStyle(t){this.ctx.strokeStyle=t}get lineWidth(){return this.ctx.lineWidth}set lineWidth(t){this.ctx.lineWidth=t}get globalAlpha(){return this.ctx.globalAlpha}set globalAlpha(t){this.ctx.globalAlpha=t}}class L{constructor(t){this.canvasElement=t,this.eventEmitter=new v,this.viewport={x:0,y:0,width:0,height:0},this.updateSize()}getViewport(){return{...this.viewport}}setViewport(t){({...this.viewport},t.x!==void 0&&(this.viewport.x=t.x)),t.y!==void 0&&(this.viewport.y=t.y),t.width!==void 0&&(this.viewport.width=t.width,this.updateCanvasSize()),t.height!==void 0&&(this.viewport.height=t.height,this.updateCanvasSize()),this.eventEmitter.emit("change",this.viewport)}translate(t,e){this.setViewport({x:this.viewport.x+t,y:this.viewport.y+e})}updateSize(){const t=this.canvasElement.getBoundingClientRect();this.setViewport({width:t.width,height:t.height})}updateCanvasSize(){const t=D();this.canvasElement.width=this.viewport.width*t,this.canvasElement.height=this.viewport.height*t,this.canvasElement.style.width=this.viewport.width+"px",this.canvasElement.style.height=this.viewport.height+"px"}getCenter(){return{x:this.viewport.x+this.viewport.width/2,y:this.viewport.y+this.viewport.height/2}}sceneToViewport(t){return{x:t.x-this.viewport.x,y:t.y-this.viewport.y}}viewportToScene(t){return{x:t.x+this.viewport.x,y:t.y+this.viewport.y}}on(t,e){this.eventEmitter.on(t,e)}off(t,e){this.eventEmitter.off(t,e)}}class V{constructor(t){this.viewportManager=t,this.eventEmitter=new v,this.zoom=1,this.minZoom=.1,this.maxZoom=10}getZoom(){return this.zoom}setZoom(t,e){const s=this.zoom,i=ut(t,this.minZoom,this.maxZoom);i!==this.zoom&&(this.zoom=i,e&&this.adjustViewportForZoom(s,e),this.eventEmitter.emit("change",this.zoom,s))}zoomIn(t){this.setZoom(this.zoom*1.2,t)}zoomOut(t){this.setZoom(this.zoom/1.2,t)}resetZoom(){this.setZoom(1);const t=this.viewportManager.getViewport();this.viewportManager.setViewport({x:-t.width/2,y:-t.height/2})}handleWheel(t){t.preventDefault();const e=t.target.getBoundingClientRect(),s={x:t.clientX-e.left,y:t.clientY-e.top};t.deltaY<0?this.zoomIn(s):this.zoomOut(s)}adjustViewportForZoom(t,e){const s=this.viewportManager.getViewport(),i=X(e.x,e.y,t,s.x,s.y),n=i.x-e.x/this.zoom,o=i.y-e.y/this.zoom;this.viewportManager.setViewport({x:n,y:o})}on(t,e){this.eventEmitter.on(t,e)}off(t,e){this.eventEmitter.off(t,e)}}class N{constructor(){this.selectedItems=[],this.eventEmitter=new v}getSelectedItems(){return[...this.selectedItems]}selectItem(t){this.selectedItems.includes(t)||(this.selectedItems=[t],this.eventEmitter.emit("change",this.selectedItems))}selectItems(t){this.selectedItems=[...t],this.eventEmitter.emit("change",this.selectedItems)}addToSelection(t){this.selectedItems.includes(t)||(this.selectedItems.push(t),this.eventEmitter.emit("change",this.selectedItems))}removeFromSelection(t){const e=this.selectedItems.indexOf(t);e!==-1&&(this.selectedItems.splice(e,1),this.eventEmitter.emit("change",this.selectedItems))}clearSelection(){this.selectedItems.length>0&&(this.selectedItems=[],this.eventEmitter.emit("change",this.selectedItems))}isSelected(t){return this.selectedItems.includes(t)}getSelectionBounds(){if(this.selectedItems.length===0)return null;let t=1/0,e=1/0,s=-1/0,i=-1/0;for(const n of this.selectedItems){const o=n.getBounds();t=Math.min(t,o.x),e=Math.min(e,o.y),s=Math.max(s,o.x+o.width),i=Math.max(i,o.y+o.height)}return{x:t,y:e,width:s-t,height:i-e}}notifyElementsChanged(){this.selectedItems.length>0&&this.eventEmitter.emit("elementsChanged",this.selectedItems)}on(t,e){this.eventEmitter.on(t,e)}off(t,e){this.eventEmitter.off(t,e)}}class Z{constructor(){this.eventEmitter=new v,this.graphics=[],this.render=Y(()=>this.performRender()),this.renderer=null}setRenderer(t){this.renderer=t}addGraphics(t){this.graphics.push(t),this.eventEmitter.emit("change"),this.requestRender()}removeGraphics(t){const e=this.graphics.indexOf(t);e!==-1&&(this.graphics.splice(e,1),this.eventEmitter.emit("change"),this.requestRender())}getAllGraphics(){return[...this.graphics]}findGraphicsAt(t){for(let e=this.graphics.length-1;e>=0;e--){const s=this.graphics[e];if(s.hitTest(t))return s}return null}clear(){this.graphics=[],this.eventEmitter.emit("change"),this.requestRender()}requestRender(){this.render()}performRender(){if(!this.renderer){console.warn("SceneManager: No renderer available");return}}on(t,e){this.eventEmitter.on(t,e)}off(t,e){this.eventEmitter.off(t,e)}}class q{constructor(t){this.canvas=t,this.eventEmitter=new v,this.isSpacePressing=!1,this.isWheelBtnPressing=!1,this.unbindHandlers=[],this.bindEvents()}bindEvents(){const t=s=>{if(s.code==="Space"){const i=this.isSpacePressing;this.isSpacePressing=s.type==="keydown",i!==this.isSpacePressing&&(this.eventEmitter.emit("spaceToggle",this.isSpacePressing),s.preventDefault())}},e=s=>{if(s.target===this.canvas&&s.button===1){const i=this.isWheelBtnPressing;this.isWheelBtnPressing=s.type==="pointerdown",i!==this.isWheelBtnPressing&&(this.eventEmitter.emit("wheelBtnToggle",this.isWheelBtnPressing,s),s.preventDefault())}};document.addEventListener("keydown",t),document.addEventListener("keyup",t),this.canvas.addEventListener("pointerdown",e),this.canvas.addEventListener("pointerup",e),this.unbindHandlers.push(()=>{document.removeEventListener("keydown",t),document.removeEventListener("keyup",t),this.canvas.removeEventListener("pointerdown",e),this.canvas.removeEventListener("pointerup",e)})}on(t,e){this.eventEmitter.on(t,e)}off(t,e){this.eventEmitter.off(t,e)}destroy(){this.unbindHandlers.forEach(t=>t()),this.unbindHandlers=[]}}class O{constructor(t,e,s,i){this.canvas=t,this.viewportManager=e,this.zoomManager=s,this.hostEventManager=i,this.eventEmitter=new v,this._active=!1,this._isPressing=!1,this.isEnableDragCanvasBySpace=!0,this.startVwPos={x:0,y:0},this.startViewportPos={x:0,y:0},this.bindHostEvents(),this.bindMouseEvents()}bindHostEvents(){this.hostEventManager.on("spaceToggle",t=>{this.isEnableDragCanvasBySpace&&(t?this.active():this.inactive())}),this.hostEventManager.on("wheelBtnToggle",(t,e)=>{this.isEnableDragCanvasBySpace&&(t?this.active(e):this.inactive())})}bindMouseEvents(){const t=i=>{if(!this._active||i.target!==this.canvas||i.button!==0&&i.button!==1)return;this._isPressing=!0;const n=this.canvas.getBoundingClientRect();this.startVwPos={x:i.clientX-n.left,y:i.clientY-n.top},this.startViewportPos=this.viewportManager.getViewport(),this.canvas.style.cursor="grabbing",i.preventDefault()},e=i=>{if(!this._isPressing)return;const n=this.canvas.getBoundingClientRect(),o={x:i.clientX-n.left,y:i.clientY-n.top},a=o.x-this.startVwPos.x,h=o.y-this.startVwPos.y,c=this.zoomManager.getZoom(),l=this.startViewportPos.x-a/c,f=this.startViewportPos.y-h/c;this.viewportManager.setViewport({x:l,y:f}),i.preventDefault()},s=()=>{this._isPressing&&(this._isPressing=!1,this.canvas.style.cursor=this._active?"grab":"default")};this.canvas.addEventListener("pointerdown",t),window.addEventListener("pointermove",e),window.addEventListener("pointerup",s)}isActive(){return this._active}isPressing(){return this._isPressing}active(t){this._active||(this._active=!0,this.canvas.style.cursor="grab",this.eventEmitter.emit("activeChange",!0))}inactive(){this._active&&(this._active=!1,this._isPressing=!1,this.canvas.style.cursor="default",this.eventEmitter.emit("activeChange",!1))}enableDragBySpace(){this.isEnableDragCanvasBySpace=!0}disableDragBySpace(){this.isEnableDragCanvasBySpace=!1}on(t,e){this.eventEmitter.on(t,e)}off(t,e){this.eventEmitter.off(t,e)}}class G{constructor(t){this.selectionManager=t,this.eventEmitter=new v,this.box=null,this.isHovered=!1,this.enableDrawSizeIndicator=!0,this.strokeColor="#1890ff",this.strokeWidth=1,this.selectionBoxStrokeColor="#1890ff",this.selectionBoxStrokeWidth=1,this.bindEvents()}bindEvents(){this.selectionManager.on("change",this.updateBounds.bind(this)),this.selectionManager.on("elementsChanged",this.updateBounds.bind(this))}isHover(){return this.isHovered}setHover(t){this.isHovered!==t&&(this.isHovered=t,this.eventEmitter.emit("hoverChange",t))}getBox(){return this.box?{...this.box}:null}updateBounds(){const t=this.selectionManager.getSelectedItems();if(t.length===0){this.setBox(null);return}if(t.length===1){const e=t[0];console.log("🔧 SelectedBoxManager.updateBounds (single item):",{itemId:e.id,attrs:e.attrs,getSize:e.getSize(),getWorldTransform:e.getWorldTransform()});const s=e.attrs.x||0,i=e.attrs.y||0;let n;e.attrs.transform?(n=[...e.attrs.transform],n[4]=s,n[5]=i):n=[1,0,0,1,s,i],this.setBox({width:e.attrs.width,height:e.attrs.height,transform:n})}else{const e=this.calculateCombinedBounds(t);this.setBox({width:e.width,height:e.height,transform:[1,0,0,1,e.x,e.y]})}}calculateCombinedBounds(t){let e=1/0,s=1/0,i=-1/0,n=-1/0;return t.forEach(o=>{const a=o.getBounds();e=Math.min(e,a.x),s=Math.min(s,a.y),i=Math.max(i,a.x+a.width),n=Math.max(n,a.y+a.height)}),{x:e,y:s,width:i-e,height:n-s}}setBox(t){this.box=t,this.eventEmitter.emit("boundsChange",t)}draw(t){if(!this.box)return;t.save();const e=this.box.transform;t.setTransform(e[0],e[1],e[2],e[3],e[4],e[5]),t.strokeStyle=this.selectionBoxStrokeColor,t.lineWidth=this.selectionBoxStrokeWidth,t.strokeRect(0,0,this.box.width,this.box.height),this.enableDrawSizeIndicator&&this.isHovered&&this.drawSizeIndicator(t),t.restore()}drawSizeIndicator(t){if(!this.box)return;const e=Math.round(this.box.width),s=Math.round(this.box.height),i=`${e} × ${s}`,n=this.box.width/2,o=0,h=i.length*7,c=16,l=4,f=h+l*2,u=c+l*2,d=n-f/2,x=o-u-8;t.fillStyle="rgba(0, 0, 0, 0.8)",t.fillRect(d,x,f,u)}containsPoint(t){if(!this.box)return!1;const e=this.box.transform,s=e[0]*e[3]-e[1]*e[2];if(Math.abs(s)<1e-10)return!1;const i=1/s,n=i*(e[3]*(t.x-e[4])-e[2]*(t.y-e[5])),o=i*(-e[1]*(t.x-e[4])+e[0]*(t.y-e[5]));return n>=0&&n<=this.box.width&&o>=0&&o<=this.box.height}getWorldBounds(){if(!this.box)return null;const t=this.box.transform;return{x:t[4],y:t[5],width:this.box.width,height:this.box.height}}on(t,e){this.eventEmitter.on(t,e)}off(t,e){this.eventEmitter.off(t,e)}destroy(){this.eventEmitter.removeAllListeners()}}class y{constructor(t=1,e=0,s=0,i=1,n=0,o=0){this.a=t,this.b=e,this.c=s,this.d=i,this.tx=n,this.ty=o}static fromArray(t){return new y(t[0],t[1],t[2],t[3],t[4],t[5])}set(t,e,s,i,n,o){return this.a=t,this.b=e,this.c=s,this.d=i,this.tx=n,this.ty=o,this}getArray(){return[this.a,this.b,this.c,this.d,this.tx,this.ty]}apply(t){const e=t.x,s=t.y;return{x:this.a*e+this.c*s+this.tx,y:this.b*e+this.d*s+this.ty}}applyInverse(t){const e=1/(this.a*this.d+this.c*-this.b),s=t.x,i=t.y;return{x:this.d*e*s+-this.c*e*i+(this.ty*this.c-this.tx*this.d)*e,y:this.a*e*i+-this.b*e*s+(-this.ty*this.a+this.tx*this.b)*e}}translate(t,e){return this.tx+=t,this.ty+=e,this}scale(t,e){return this.a*=t,this.d*=e,this.c*=t,this.b*=e,this.tx*=t,this.ty*=e,this}rotate(t){const e=Math.cos(t),s=Math.sin(t),i=this.a,n=this.c,o=this.tx;return this.a=i*e-this.b*s,this.b=i*s+this.b*e,this.c=n*e-this.d*s,this.d=n*s+this.d*e,this.tx=o*e-this.ty*s,this.ty=o*s+this.ty*e,this}append(t){const e=this.a,s=this.b,i=this.c,n=this.d;return this.a=t.a*e+t.b*i,this.b=t.a*s+t.b*n,this.c=t.c*e+t.d*i,this.d=t.c*s+t.d*n,this.tx=t.tx*e+t.ty*i+this.tx,this.ty=t.tx*s+t.ty*n+this.ty,this}prepend(t){const e=this.tx;if(t.a!==1||t.b!==0||t.c!==0||t.d!==1){const s=this.a,i=this.c;this.a=s*t.a+this.b*t.c,this.b=s*t.b+this.b*t.d,this.c=i*t.a+this.d*t.c,this.d=i*t.b+this.d*t.d}return this.tx=e*t.a+this.ty*t.c+t.tx,this.ty=e*t.b+this.ty*t.d+t.ty,this}invert(){const t=this.a,e=this.b,s=this.c,i=this.d,n=this.tx,o=t*i-e*s;return this.a=i/o,this.b=-e/o,this.c=-s/o,this.d=t/o,this.tx=(s*this.ty-i*n)/o,this.ty=-(t*this.ty-e*n)/o,this}identity(){return this.a=1,this.b=0,this.c=0,this.d=1,this.tx=0,this.ty=0,this}clone(){return new y(this.a,this.b,this.c,this.d,this.tx,this.ty)}copyFrom(t){return this.a=t.a,this.b=t.b,this.c=t.c,this.d=t.d,this.tx=t.tx,this.ty=t.ty,this}}function yt(){return[1,0,0,1,0,0]}function U(r,t){return{x:r.x*t[0]+r.y*t[2]+t[4],y:r.x*t[1]+r.y*t[3]+t[5]}}function I(r){return Math.atan2(r[1],r[0])}function $(r){return r[0]*r[3]-r[1]*r[2]<0}function B(r){return r*(180/Math.PI)}function j(r){return r=r%360,r<0&&(r+=360),r}function T(r,t){const{x:e,y:s,width:i,height:n}=r,o=i>=0?e:e+i,a=n>=0?s:s+n,h=Math.abs(i),c=Math.abs(n);let l=[{x:o,y:a},{x:o+h,y:a},{x:o+h,y:a+c},{x:o,y:a+c}];if(t){const f=new y(...t);l=l.map(u=>{const d=f.apply(u);return{x:d.x,y:d.y}})}return l}function J(r,t){const{x:e,y:s,width:i,height:n}=r,o=i>=0?e:e+i,a=n>=0?s:s+n,h=Math.abs(i),c=Math.abs(n);return[{x:o+h/2,y:a},{x:o+h,y:a+c/2},{x:o+h/2,y:a+c},{x:o,y:a+c/2}]}function Q(r,t){if(typeof t=="number")return{x:r.x-t,y:r.y-t,width:r.width+t*2,height:r.height+t*2};const[e,s,i,n]=t;return{x:r.x-n,y:r.y-e,width:r.width+n+s,height:r.height+e+i}}function C(r,t){const e=t.x-r.x,s=t.y-r.y;return Math.sqrt(e*e+s*s)}function tt(r,t,e){const s=r.x*t.x+r.y*t.y,i=Math.sqrt(r.x*r.x+r.y*r.y)*Math.sqrt(t.x*t.x+t.y*t.y);let n=s/i;n>1?n=1:n<-1&&(n=-1);let o=Math.acos(n);return r.x*t.y-r.y*t.x<0&&(o=2*Math.PI-o),o}function pt(r,t,e){const s=t.x-r.x,i=t.y-r.y,n=e.x-r.x,o=e.y-r.y,a=n*s+o*i,h=s*s+i*i;let c=0;h!==0&&(c=a/h);const l={x:r.x+c*s,y:r.y+c*i};return{t:c,point:l}}function wt(r,t,e=4){let s={x:0,y:0},i=1/0;for(let n=1;n<=e;n++){const o=Math.PI/e*n,a={x:r.x+Math.cos(o),y:r.y+Math.sin(o)},{point:h}=pt(r,a,t),c=C(h,t);if(c===0)return h;c<i&&(i=c,s=h)}return s}class z{constructor(t){this.cx=t.cx??0,this.cy=t.cy??0,this.type=t.type,this.padding=t.padding??0,this.size=t.size,this.fill=t.fill,this.stroke=t.stroke,this.strokeWidth=t.strokeWidth,this.isTransformHandle=t.isTransformHandle??!1,this.getCursor=t.getCursor,t.rotation!==void 0&&(this.rotation=t.rotation),t.transform&&(this.transform=t.transform),t.hitTest&&(this.hitTest=t.hitTest)}draw(t){if(!(this.fill==="transparent"&&(this.stroke==="transparent"||this.strokeWidth===0))&&!(!t||typeof t.save!="function")){t.save();try{const e=this.size/2,s=this.cx-e,i=this.cy-e;console.log(`🎯 Drawing handle ${this.type}:`,{cx:this.cx,cy:this.cy,size:this.size,x:s,y:i,fill:this.fill,stroke:this.stroke}),this.fill&&this.fill!=="transparent"&&(t.fillStyle=this.fill,t.fillRect(s,i,this.size,this.size)),this.stroke&&this.stroke!=="transparent"&&this.strokeWidth>0&&(t.strokeStyle=this.stroke,t.lineWidth=this.strokeWidth,t.strokeRect(s,i,this.size,this.size))}finally{t.restore()}}}containsPoint(t,e=0,s=null){if(this.hitTest)return this.hitTest(t,e,s);const i=(this.size+this.padding+e)/2;return t.x>=this.cx-i&&t.x<=this.cx+i&&t.y>=this.cy-i&&t.y<=this.cy+i}updatePosition(t,e){this.cx=t,this.cy=e}updateTransform(t){this.transform=t}updateRotation(t){this.rotation=t}getCursorAtPoint(t){return this.getCursor(this.type,t)}}const et=(r,t)=>{if(!t)return{type:"default"};if(t.height===0)return{type:"move"};if(r==="n"||r==="s"){const o=[-t.transform[1],t.transform[0],-t.transform[3],t.transform[2],t.transform[4],t.transform[5]],a=I(o);return{type:"resize",degree:B(a)}}const e=I(t.transform),s=$(t.transform);let i=0;switch(r){case"se":case"nw":i=-45;break;case"ne":case"sw":i=45;break;case"e":case"w":i=90;break;default:return console.warn("Unknown resize handle type:",r),{type:"default"}}const n=B(e)+(s?-i:i);return{type:"resize",degree:j(n)}},vt=(r,t)=>{if(!t)return{type:"default"};const e=I(t.transform),s=$(t.transform);let i=0;return t.height===0?i={neRotation:90,seRotation:90,swRotation:270,nwRotation:270}[r]||0:i={neRotation:45,seRotation:135,swRotation:225,nwRotation:315}[r]||0,{type:"rotation",degree:j(B(e)+(s?-i:i))}},E={handleStroke:"#1592fe",handleFill:"#fcfcfc",handleStrokeWidth:2,handleSize:7,neswHandleWidth:10};class xt{constructor(t={}){this.settings={...E,...t}}get(t){return this.settings[t]}set(t,e){this.settings[t]=e}getAll(){return{...this.settings}}update(t){this.settings={...this.settings,...t}}}const St=r=>(t,e,s)=>{if(!s)return!1;const i=Math.max(e,8),n={width:s.width,height:s.height};let o;switch(r){case"n":o={x:-i,y:-i,width:n.width+i*2,height:i*2};break;case"s":o={x:-i,y:n.height-i,width:n.width+i*2,height:i*2};break;case"e":o={x:n.width-i,y:-i,width:i*2,height:n.height+i*2};break;case"w":o={x:-i,y:-i,width:i*2,height:n.height+i*2};break}const a=s.transform,h=a[0]*a[3]-a[1]*a[2];if(Math.abs(h)<1e-10)return!1;const c=1/h,l=c*(a[3]*(t.x-a[4])-a[2]*(t.y-a[5])),f=c*(-a[1]*(t.x-a[4])+a[0]*(t.y-a[5]));return l>=o.x&&l<=o.x+o.width&&f>=o.y&&f<=o.y+o.height},Mt=r=>{const t=new Map,e=E;return["nw","ne","se","sw"].forEach(o=>{t.set(o,new z({type:o,size:e.handleSize,fill:e.handleFill,stroke:e.handleStroke,strokeWidth:e.handleStrokeWidth,padding:3,isTransformHandle:!0,getCursor:et}))}),["n","e","s","w"].forEach(o=>{t.set(o,new z({type:o,size:e.handleSize,fill:"transparent",stroke:"transparent",strokeWidth:0,padding:8,isTransformHandle:!0,hitTest:St(o),getCursor:et}))}),["nwRotation","neRotation","seRotation","swRotation"].forEach(o=>{t.set(o,new z({type:o,size:e.handleSize,fill:e.handleFill,stroke:e.handleStroke,strokeWidth:e.handleStrokeWidth,padding:4,isTransformHandle:!0,getCursor:vt}))}),t},bt=(r,t,e=1)=>{console.log("🔧 updateHandlePositions called:",{rect:t,zoom:e,handleCount:r.size,rectWidth:t.width,rectHeight:t.height,rectTransform:t.transform});const s=E.handleSize,i=E.neswHandleWidth;console.log("🎯 Handle settings:",{handleSize:s,neswHandleWidth:i,handleSizeInScene:s/e,zoom:e});const n={x:0,y:0,width:t.width,height:t.height},o=T(n,t.transform);J(n).map(p=>U(p,t.transform));const a=s/2/e,h=Q(n,a),c=T(h,t.transform);Object.entries({nw:0,ne:1,se:2,sw:3}).forEach(([p,w])=>{const m=r.get(p);m&&(console.log(`🎯 Positioning ${p} handle:`,{position:o[w],size:s/e}),m.updatePosition(o[w].x,o[w].y),m.size=s/e)});const f=40,u={n:0,e:1,s:2,w:3},d=new Array(4).fill(0);Math.abs(t.width)*e<f&&(d[1]=d[3]=i/2/e),Math.abs(t.height)*e<f&&(d[0]=d[2]=i/2/e);const x=Q(n,d),M=J(x).map(p=>U(p,t.transform));Object.entries(u).forEach(([p,w])=>{const m=r.get(p);m&&(m.updatePosition(M[w].x,M[w].y),m.size=s/e)}),Object.entries({nwRotation:0,neRotation:1,seRotation:2,swRotation:3}).forEach(([p,w])=>{const m=r.get(p);m&&(m.updatePosition(c[w].x,c[w].y),m.size=s/e)})},A=(r,t)=>Math.abs(r.width)*t>=20&&Math.abs(r.height)*t>=20,st=(r,t,e)=>e&&A(r,t),Pt=(r,t,e,s=5,i=!1)=>{const n=["nw","ne","se","sw","n","e","s","w"];i&&n.push("nwRotation","neRotation","seRotation","swRotation");for(const o of n){const a=r.get(o);if(a&&a.containsPoint(t,s,e))return a}return null};class it{constructor(t,e,s,i){this.selectionManager=t,this.viewportManager=e,this.zoomManager=s,this.selectedBoxManager=i,this.transformHandles=new Map,this.customHandles=[],this.customHandlesVisible=!1,this.selectedBoxRect=null,this.enableTransformControl=!0,this.settings=new xt,this.createTransformHandles(),this.bindEvents()}bindEvents(){this.selectionManager.on("change",this.onSelectionChanged.bind(this)),this.selectionManager.on("elementsChanged",this.onSelectionChanged.bind(this)),this.zoomManager.on("change",this.onSelectionChanged.bind(this))}onSelectionChanged(){const t=this.selectionManager.getSelectedItems();if(t.length===0){this.selectedBoxRect=null;return}this.selectedBoxManager?this.selectedBoxRect=this.selectedBoxManager.getBox():this.selectedBoxRect=this.calculateSelectedBounds(t)}calculateSelectedBounds(t){if(t.length===1){const n=t[0],o=n.attrs.width||100,a=n.attrs.height||100;let h;return n.attrs.transform?h=n.attrs.transform:h=[1,0,0,1,n.attrs.x||0,n.attrs.y||0],console.log("🎯 ControlHandleManager.calculateSelectedBounds (single):",{elementId:n.id,width:o,height:a,transform:h,elementAttrs:n.attrs}),{width:o,height:a,transform:h}}const e=t.map(n=>this.getBboxForElement(n)),s=this.mergeBoxes(e),i=this.boxToRect(s);return{width:i.width,height:i.height,transform:[1,0,0,1,i.x,i.y]}}getBboxForElement(t){const e=t.attrs.width||0,s=t.attrs.height||0;let i;return t.attrs.transform?i=t.attrs.transform:i=[1,0,0,1,t.attrs.x||0,t.attrs.y||0],this.calcRectBbox({width:e,height:s,transform:i})}calcRectBbox(t){const{width:e,height:s,transform:i}=t,n=new y(...i),a=[{x:0,y:0},{x:e,y:0},{x:e,y:s},{x:0,y:s}].map(u=>n.apply(u));let h=1/0,c=1/0,l=-1/0,f=-1/0;for(const u of a)h=Math.min(h,u.x),c=Math.min(c,u.y),l=Math.max(l,u.x),f=Math.max(f,u.y);return{minX:h,minY:c,maxX:l,maxY:f}}mergeBoxes(t){if(t.length===0)throw new Error("the count of boxes can not be 0");let e=1/0,s=1/0,i=-1/0,n=-1/0;for(const o of t)e=Math.min(e,o.minX),s=Math.min(s,o.minY),i=Math.max(i,o.maxX),n=Math.max(n,o.maxY);return{minX:e,minY:s,maxX:i,maxY:n}}boxToRect(t){return{x:t.minX,y:t.minY,width:t.maxX-t.minX,height:t.maxY-t.minY}}createTransformHandles(){this.settings.get("handleSize"),this.settings.get("handleFill"),this.settings.get("handleStroke"),this.settings.get("handleStrokeWidth"),this.transformHandles=Mt()}updateTransformHandles(t){if(!this.enableTransformControl)return;const e=this.zoomManager.getZoom();console.log("🎯 ControlHandleManager.updateTransformHandles:",{rect:t,zoom:e,handleCount:this.transformHandles.size}),bt(this.transformHandles,t,e)}checkEnableRender(t){const e=T({x:0,y:0,width:Math.abs(t.width),height:Math.abs(t.height)},t.transform).map(i=>this.viewportManager.sceneToViewport(i)),s=20;return C(e[0],e[1])>=s||C(e[1],e[2])>=s}draw(t){const e=this.selectedBoxRect;if(!e||!this.checkEnableRender(e))return;this.updateTransformHandles(e);const s=this.zoomManager.getZoom();if(console.log("🎯 ControlHandleManager.draw:",{rect:this.selectedBoxRect,zoom:s,handlesCount:this.transformHandles.size,viewport:this.viewportManager.getViewport()}),!A(e,s))return;const i=st(e,s,this.customHandlesVisible),n=Array.from(this.transformHandles.values()).filter(a=>a.type.includes("Rotation")?i:!0);n.sort((a,h)=>{const c=a.type.includes("Rotation")?2:["nw","ne","se","sw"].includes(a.type)?0:1,l=h.type.includes("Rotation")?2:["nw","ne","se","sw"].includes(h.type)?0:1;return c-l});const o=t.renderer;n.forEach(a=>{a.draw(o)}),this.customHandlesVisible&&this.customHandles.forEach(a=>{a.draw(o)})}getHandleInfoByPoint(t){if(!this.selectedBoxRect||!this.shouldRenderTransformControl())return null;const e=this.zoomManager.getZoom(),s=5/e;if(!A(this.selectedBoxRect,e))return null;const i=st(this.selectedBoxRect,e,this.customHandlesVisible),n=Pt(this.transformHandles,t,this.selectedBoxRect,s,i);if(n){const o=n.getCursorAtPoint(this.selectedBoxRect);return{handleName:n.type,cursor:o}}for(const o of this.customHandles)if(o.containsPoint(t,s,this.selectedBoxRect)){const a=o.getCursorAtPoint(this.selectedBoxRect);return{handleName:o.type,cursor:a}}return null}shouldRenderTransformControl(){return this.selectedBoxRect!==null&&this.enableTransformControl}setCustomHandles(t){this.customHandles=t}getCustomHandles(){return this.customHandles}showCustomHandles(){this.customHandlesVisible=!0}hideCustomHandles(){this.customHandlesVisible=!1}getSelectedBox(){return this.selectedBoxRect}destroy(){this.transformHandles.clear(),this.customHandles=[],this.selectedBoxRect=null}}class nt{constructor(t,e){this.canvas=t,this.hostEventManager=e,this.eventEmitter=new v,this.tools=new Map,this.activeTool=null,this._isDragging=!1,this.handlePointerDown=s=>{var n,o;if(!this.activeTool||s.button!==0||this.hostEventManager.isSpacePressing)return;s.preventDefault(),this.canvas.setPointerCapture(s.pointerId),this._isDragging=!0;const i=this.convertEvent(s);(o=(n=this.activeTool).onStart)==null||o.call(n,i)},this.handlePointerMove=s=>{var n,o;if(!this.activeTool)return;s.preventDefault();const i=this.convertEvent(s);this._isDragging&&((o=(n=this.activeTool).onMove)==null||o.call(n,i))},this.handlePointerUp=s=>{var n,o;if(!this.activeTool)return;s.preventDefault(),this.canvas.releasePointerCapture(s.pointerId),this._isDragging=!1;const i=this.convertEvent(s);(o=(n=this.activeTool).onEnd)==null||o.call(n,i)},this.handlePointerCancel=s=>{var i,n;this.activeTool&&(this.canvas.releasePointerCapture(s.pointerId),this._isDragging=!1,(n=(i=this.activeTool).onCancel)==null||n.call(i))},this.bindEvents()}registerTool(t){this.tools.set(t.name,t)}setActiveTool(t){var s,i;const e=this.tools.get(t);e&&e!==this.activeTool&&(this.activeTool&&((i=(s=this.activeTool).onCancel)==null||i.call(s)),this.activeTool=e,this.canvas.style.cursor=e.cursor,this.eventEmitter.emit("toolChange",e))}getActiveTool(){return this.activeTool}bindEvents(){this.canvas.addEventListener("pointerdown",this.handlePointerDown),this.canvas.addEventListener("pointermove",this.handlePointerMove),this.canvas.addEventListener("pointerup",this.handlePointerUp),this.canvas.addEventListener("pointercancel",this.handlePointerCancel)}convertEvent(t){const e=this.canvas.getBoundingClientRect();return{clientX:t.clientX-e.left,clientY:t.clientY-e.top,button:t.button,shiftKey:t.shiftKey,ctrlKey:t.ctrlKey,metaKey:t.metaKey,altKey:t.altKey}}isDragging(){return this._isDragging}destroy(){this.canvas.removeEventListener("pointerdown",this.handlePointerDown),this.canvas.removeEventListener("pointermove",this.handlePointerMove),this.canvas.removeEventListener("pointerup",this.handlePointerUp),this.canvas.removeEventListener("pointercancel",this.handlePointerCancel)}on(t,e){this.eventEmitter.on(t,e)}off(t,e){this.eventEmitter.off(t,e)}}class rt{constructor(t){this.deps=t,this.isActive=!1,this.startPoint={x:-1,y:-1},this.dragPoint=null,this.selectedItems=[],this.originPositions=new Map}onActive(){this.isActive=!0,this.selectedItems=this.deps.selectionManager.getSelectedItems(),this.originPositions.clear();for(const t of this.selectedItems)this.originPositions.set(t.id,{x:t.attrs.x||0,y:t.attrs.y||0})}onInactive(){this.isActive=!1,this.selectedItems=[],this.originPositions.clear()}onStart(t){this.isActive&&(this.startPoint=this.deps.getSceneCursorXY(t),this.dragPoint=this.deps.getCursorXY(t))}onDrag(t){!this.isActive||!this.dragPoint||(this.dragPoint=this.deps.getCursorXY(t),this.move())}onEnd(){this.isActive&&console.log("🎯 Move completed for",this.selectedItems.length,"items")}afterEnd(){this.dragPoint=null}move(){if(!this.dragPoint||this.selectedItems.length===0)return;const t=this.deps.toScenePt(this.dragPoint.x,this.dragPoint.y),e=t.x-this.startPoint.x,s=t.y-this.startPoint.y;for(const i of this.selectedItems){const n=this.originPositions.get(i.id);n&&i.setPosition&&i.setPosition(n.x+e,n.y+s)}this.deps.selectionManager.notifyElementsChanged(),this.deps.requestRender()}}class ot{constructor(t){this.deps=t,this.isActive=!1,this.startPoint={x:-1,y:-1},this.dragPoint=null,this.isShiftPressing=!1,this.initialSelection=[]}onActive(){this.isActive=!0}onInactive(){this.isActive=!1,this.deps.clearSelectionBox(),this.deps.requestRender()}onStart(t){this.isActive&&(this.startPoint=this.deps.getSceneCursorXY(t),this.dragPoint=this.deps.getCursorXY(t),this.isShiftPressing=t.shiftKey||!1,this.initialSelection=this.deps.selectionManager.getSelectedItems(),this.isShiftPressing||this.deps.selectionManager.clearSelection())}onDrag(t){!this.isActive||!this.dragPoint||(this.dragPoint=this.deps.getCursorXY(t),this.updateSelection())}onEnd(){this.isActive&&(this.deps.clearSelectionBox(),this.deps.requestRender())}afterEnd(){this.dragPoint=null,this.isShiftPressing=!1,this.initialSelection=[]}updateSelection(){if(!this.dragPoint)return;const t=this.deps.toScenePt(this.dragPoint.x,this.dragPoint.y),e={x:Math.min(this.startPoint.x,t.x),y:Math.min(this.startPoint.y,t.y),width:Math.abs(t.x-this.startPoint.x),height:Math.abs(t.y-this.startPoint.y)};this.deps.setSelectionBox(e);const s=this.getElementsInSelection(e);if(this.isShiftPressing){const i=[...this.initialSelection];for(const n of s)i.find(o=>o.id===n.id)||i.push(n);this.deps.selectionManager.selectItems(i)}else this.deps.selectionManager.selectItems(s);this.deps.requestRender()}getElementsInSelection(t){const e=this.deps.sceneManager.getAllGraphics(),s=[];for(const i of e)this.isGraphicInRect(i,t)&&s.push(i);return s}isGraphicInRect(t,e){const s=t.x||0,i=t.y||0,n=t.width||0,o=t.height||0;return!(s+n<e.x||s>e.x+e.width||i+o<e.y||i>e.y+e.height)}}const k=(r,t)=>({width:r*2,height:t*2}),Ct={sw:{getLocalOrigin:r=>({x:r,y:0}),getNewSize:(r,t)=>({width:t.x-r.x,height:r.y-t.y}),isBaseWidthWhenKeepRatio:r=>r,getSizeWhenScaleFromCenter:k},se:{getLocalOrigin:()=>({x:0,y:0}),getNewSize:(r,t)=>({width:r.x-t.x,height:r.y-t.y}),isBaseWidthWhenKeepRatio:r=>r,getSizeWhenScaleFromCenter:k},nw:{getLocalOrigin:(r,t)=>({x:r,y:t}),getNewSize:(r,t)=>({width:t.x-r.x,height:t.y-r.y}),isBaseWidthWhenKeepRatio:r=>r,getSizeWhenScaleFromCenter:k},ne:{getLocalOrigin:(r,t)=>({x:0,y:t}),getNewSize:(r,t)=>({width:r.x-t.x,height:t.y-r.y}),isBaseWidthWhenKeepRatio:r=>r,getSizeWhenScaleFromCenter:k},n:{getLocalOrigin:(r,t)=>({x:r/2,y:t}),getNewSize:(r,t,e)=>({width:e.width,height:t.y-r.y}),isBaseWidthWhenKeepRatio:()=>!1,getSizeWhenScaleFromCenter:(r,t)=>({width:r,height:t*2})},s:{getLocalOrigin:r=>({x:r/2,y:0}),getNewSize:(r,t,e)=>({width:e.width,height:r.y-t.y}),isBaseWidthWhenKeepRatio:()=>!1,getSizeWhenScaleFromCenter:(r,t)=>({width:r,height:t*2})},e:{getLocalOrigin:(r,t)=>({x:0,y:t/2}),getNewSize:(r,t,e)=>({width:r.x-t.x,height:e.height}),isBaseWidthWhenKeepRatio:()=>!0,getSizeWhenScaleFromCenter:(r,t)=>({width:r*2,height:t})},w:{getLocalOrigin:(r,t)=>({x:r,y:t/2}),getNewSize:(r,t,e)=>({width:t.x-r.x,height:e.height}),isBaseWidthWhenKeepRatio:()=>!0,getSizeWhenScaleFromCenter:(r,t)=>({width:r*2,height:t})}},at=(r,t,e,s)=>{console.log("🔧 resizeRect called:",{type:r,newGlobalPt:t,rect:e,options:s});const i=Ct[r];if(!i)throw new Error(`resize type ${r} is invalid`);const{keepRatio:n,scaleFromCenter:o,noChangeWidthAndHeight:a,flip:h=!0}=s??{},c=new y(...e.transform),l={width:0,height:0,transform:c.clone()},f=o?{x:e.width/2,y:e.height/2}:i.getLocalOrigin(e.width,e.height),u=c.applyInverse(t);let d=i.getNewSize(u,f,e);if(o&&(d=i.getSizeWhenScaleFromCenter(d.width,d.height)),n){const b=e.width/e.height,_t=Math.abs(d.width/d.height)>b;i.isBaseWidthWhenKeepRatio(_t)?d.height=Math.sign(d.height)*Math.abs(d.width)/b:d.width=Math.sign(d.width)*Math.abs(d.height)*b}const x=new y,M=Math.sign(d.width)||1,K=Math.sign(d.height)||1;a?(x.scale(d.width/e.width,d.height/e.height),l.width=e.width,l.height=e.height):(l.width=Math.abs(d.width),l.height=Math.abs(d.height),x.scale(M,K)),l.transform=l.transform.append(x);const p=l.transform.apply(o?{x:l.width/2,y:l.height/2}:i.getLocalOrigin(l.width,l.height)),w=c.apply(f),m={x:w.x-p.x,y:w.y-p.y};if(l.transform.prepend(new y().translate(m.x,m.y)),!h){const b=new y().translate(-l.width/2,-l.height/2).scale(M,K).translate(l.width/2,l.height/2);l.transform.append(b)}const dt={width:l.width,height:l.height,transform:l.transform.getArray()};return console.log("🔧 resizeRect result:",dt),dt},Et=(r,t,e,s={keepPolarSnap:!1,scaleFromCenter:!1})=>{if(!["se","ne","nw","sw"].includes(r))throw new Error(`invalid type "${r}"`);const i=r==="se"||r==="ne";let n={x:0,y:0};s.scaleFromCenter?n=new y(...e.transform).apply({x:e.width/2,y:e.height/2}):i?n={x:e.transform[4],y:e.transform[5]}:n=new y(...e.transform).apply({x:e.width,y:e.height}),s.keepPolarSnap&&(t=wt(n,t));let o=C(t,n);if(s.scaleFromCenter&&(o*=2),i){const a={x:t.x-n.x,y:t.y-n.y},h=tt({x:1,y:0},{x:t.x-n.x,y:t.y-n.y}),c=new y().rotate(h).translate(n.x,n.y);return s.scaleFromCenter&&c.translate(-a.x,-a.y),{width:o,height:0,transform:c.getArray()}}else{const a={x:n.x-t.x,y:n.y-t.y},h=tt({x:1,y:0},a),c=new y().rotate(h),l=c.apply({x:o,y:e.height});return c.translate(n.x-l.x,n.y-l.y),s.scaleFromCenter&&c.translate(a.x,a.y),{width:o,height:0,transform:c.getArray()}}};class kt{constructor(t){this.deps=t,this.isActive=!1,this.startPoint={x:0,y:0},this.lastDragPoint=null,this.activeHandleName="",this.startSelectedRect=null,this.originalAttrsMap=new Map,this.originalWorldTransforms=new Map,this.updatedAttrsMap=new Map}onActive(){}onInactive(){this.reset()}onStart(t){this.startPoint=this.deps.toScenePt(t.clientX,t.clientY);const e=this.deps.controlHandleManager.getHandleInfoByPoint(this.startPoint);if(!e)return;this.activeHandleName=e.handleName,this.isActive=!0;const s=this.deps.selectionManager.getSelectedItems();if(this.originalAttrsMap.clear(),this.originalWorldTransforms.clear(),this.updatedAttrsMap.clear(),s.forEach((i,n)=>{const o=i.id||`element_${n}`;this.originalAttrsMap.set(o,{...i.attrs}),this.originalWorldTransforms.set(o,i.attrs.transform||[1,0,0,1,i.attrs.x||0,i.attrs.y||0])}),this.startSelectedRect=this.deps.controlHandleManager.getSelectedBox(),!this.startSelectedRect){this.isActive=!1;return}}onDrag(t){if(!this.isActive)return;this.lastDragPoint=this.deps.toScenePt(t.clientX,t.clientY);const e={shiftKey:t.shiftKey||!1,altKey:t.altKey||!1};this.updateGraphics(e),this.deps.selectionManager.notifyElementsChanged(),this.deps.requestRender()}onEnd(){this.isActive&&(this.isActive=!1,this.deps.selectionManager.notifyElementsChanged(),this.deps.requestRender(),this.reset())}afterEnd(){this.reset()}reset(){this.isActive=!1,this.lastDragPoint=null,this.activeHandleName="",this.startSelectedRect=null,this.originalAttrsMap.clear(),this.originalWorldTransforms.clear(),this.updatedAttrsMap.clear()}getElementWorldTransform(t,e){return e.transform&&Array.isArray(e.transform)&&e.transform.length>=6?e.transform:[1,0,0,1,e.x||0,e.y||0]}updateGraphics(t){const e=this.deps.selectionManager.getSelectedItems();console.log("🔧 UpdateGraphics called:",{elementCount:e.length,activeHandle:this.activeHandleName,lastDragPoint:this.lastDragPoint,modifiers:t}),e.length===1?this.resizeSingleItem(e[0],t):e.length>1&&this.resizeMultipleItems(e,t)}resizeSingleItem(t,e){if(!this.lastDragPoint||!this.startSelectedRect)return;const s=t.id||Math.random().toString(),i=this.originalAttrsMap.get(s),n=this.originalWorldTransforms.get(s);if(!i||!n)return;const o={width:i.width||0,height:i.height||0,transform:this.getElementWorldTransform(t,i)};let a;i.height===0?a=Et(this.activeHandleName,this.lastDragPoint,o,{keepPolarSnap:e.shiftKey,scaleFromCenter:e.altKey}):a=at(this.activeHandleName,this.lastDragPoint,o,{keepRatio:e.shiftKey,scaleFromCenter:e.altKey,flip:!0}),a&&this.checkEnableUpdate(o,a)&&(console.log("🔧 Applying resize result:",{element:t.id,old:{width:t.attrs.width,height:t.attrs.height,transform:t.attrs.transform},new:{width:a.width,height:a.height,transform:a.transform}}),t.attrs.width=a.width,t.attrs.height=a.height,a.transform&&a.transform.length>=6&&(t.attrs.transform=[...a.transform]),this.updatedAttrsMap.set(s,{width:a.width,height:a.height,transform:[...a.transform],x:a.transform[4],y:a.transform[5]}))}resizeMultipleItems(t,e){if(!this.lastDragPoint||!this.startSelectedRect)return;const s={width:this.startSelectedRect.width,height:this.startSelectedRect.height,transform:this.startSelectedRect.transform},i=at(this.activeHandleName,this.lastDragPoint,s,{keepRatio:e.shiftKey,scaleFromCenter:e.altKey,flip:!0});if(!this.checkEnableUpdate(s,i))return;const n=i.width/s.width,o=i.height/s.height;t.forEach((a,h)=>{const c=a.id||`element_${h}`,l=this.originalAttrsMap.get(c);if(!l)return;const f=(l.x||0)-s.transform[4],u=(l.y||0)-s.transform[5];a.attrs.width=(l.width||0)*n,a.attrs.height=(l.height||0)*o,a.attrs.x=i.transform[4]+f*n,a.attrs.y=i.transform[5]+u*o,this.updatedAttrsMap.set(c,{width:a.attrs.width,height:a.attrs.height,x:a.attrs.x,y:a.attrs.y})})}checkEnableUpdate(t,e){return!(Math.abs(e.width)<1||Math.abs(e.height)<1)}getIsActive(){return this.isActive}getActiveHandleName(){return this.activeHandleName}}function Rt(r,t){return r.findGraphicsAt(t)}function It(r,t){return t.length===0?!1:t.some(e=>e.hitTest?e.hitTest(r):!1)}class ht{constructor(t){this.deps=t,this.name="select",this.cursor="default",this.startPoint={x:-1,y:-1},this.currStrategy=null,this.graphShouldRemovedFromSelectedIfNotMoved=null,this.strategyMove=new rt({sceneManager:t.sceneManager,selectionManager:t.selectionManager,viewportManager:t.viewportManager,zoomManager:t.zoomManager,requestRender:t.requestRender,toScenePt:t.toScenePt,getCursorXY:t.getCursorXY,getSceneCursorXY:t.getSceneCursorXY}),this.strategyDrawSelection=new ot({sceneManager:t.sceneManager,selectionManager:t.selectionManager,viewportManager:t.viewportManager,zoomManager:t.zoomManager,requestRender:t.requestRender,toScenePt:t.toScenePt,getCursorXY:t.getCursorXY,getSceneCursorXY:t.getSceneCursorXY,setSelectionBox:t.setSelectionBox,clearSelectionBox:t.clearSelectionBox}),this.strategyResize=new kt({selectionManager:t.selectionManager,controlHandleManager:t.controlHandleManager(),requestRender:t.requestRender,toScenePt:t.toScenePt,getSceneCursorXY:t.getSceneCursorXY})}onStart(t){this.currStrategy=null,this.graphShouldRemovedFromSelectedIfNotMoved=null,this.startPoint=this.deps.toScenePt(t.clientX,t.clientY);const e=t.shiftKey||!1,s=this.deps.selectionManager.getSelectedItems();if(this.deps.controlHandleManager().getHandleInfoByPoint(this.startPoint)){this.currStrategy=this.strategyResize,this.currStrategy&&this.currStrategy.onStart(t);return}const n=It(this.startPoint,s),o=Rt(this.deps.sceneManager,this.startPoint);if(o&&e&&s.find(a=>a.id===o.id)&&(this.graphShouldRemovedFromSelectedIfNotMoved=o),n)this.currStrategy=this.strategyMove;else if(o){if(!e)this.deps.selectionManager.selectItems([o]);else if(!s.find(a=>a.id===o.id)){const a=[...s,o];this.deps.selectionManager.selectItems(a)}this.deps.requestRender(),this.currStrategy=this.strategyMove}else this.currStrategy=this.strategyDrawSelection;this.currStrategy&&(this.currStrategy.onActive(),this.currStrategy.onStart(t))}onMove(t){this.currStrategy&&this.currStrategy.onDrag(t)}onEnd(t){if(!this.currStrategy)return;const e=this.deps.toScenePt(t.clientX,t.clientY),s=Math.abs(e.x-this.startPoint.x)>2||Math.abs(e.y-this.startPoint.y)>2;if(this.currStrategy.onEnd(),this.currStrategy.afterEnd(),this.currStrategy.onInactive(),this.graphShouldRemovedFromSelectedIfNotMoved&&!s){const n=this.deps.selectionManager.getSelectedItems().filter(o=>o.id!==this.graphShouldRemovedFromSelectedIfNotMoved.id);this.deps.selectionManager.selectItems(n),this.deps.requestRender()}this.currStrategy=null,this.graphShouldRemovedFromSelectedIfNotMoved=null}onCancel(){this.currStrategy&&(this.currStrategy.onInactive(),this.currStrategy=null)}}class Bt{constructor(t){this.deps=t,this.name="boxSelect",this.cursor="crosshair",this.startPoint=null,this.currentPoint=null,this.isShiftPressing=!1,this.initialSelection=[]}onStart(t){this.startPoint=this.deps.toScenePt(t.clientX,t.clientY),this.currentPoint={...this.startPoint},this.isShiftPressing=t.shiftKey||!1,this.initialSelection=this.deps.selectionManager.getSelectedItems(),this.deps.setSelectionBox(this.startPoint),this.deps.requestRender()}onMove(t){if(!this.startPoint)return;this.currentPoint=this.deps.toScenePt(t.clientX,t.clientY);const e=S(this.startPoint,this.currentPoint);this.deps.setSelectionBox(e);const s=this.getElementsInSelection(e);if(this.isShiftPressing){const i=[...this.initialSelection];for(const n of s)i.includes(n)||i.push(n);this.deps.selectionManager.selectItems(i)}else this.deps.selectionManager.selectItems(s);this.deps.requestRender()}onEnd(t){this.deps.clearSelectionBox(),this.startPoint=null,this.currentPoint=null,this.isShiftPressing=!1,this.initialSelection=[],this.deps.requestRender()}onCancel(){this.deps.clearSelectionBox(),this.startPoint=null,this.currentPoint=null,this.isShiftPressing=!1,this.initialSelection=[],this.deps.requestRender()}onKeyDown(t){}onKeyUp(t){}getElementsInSelection(t){const e=this.deps.sceneManager.getAllGraphics(),s=[];for(const i of e){if(!i.isVisible())continue;const n=i.getBounds();gt(t,n)&&s.push(i)}return s}}var W=(r=>(r.Rectangle="rectangle",r))(W||{});class ct{get x(){return this.attrs.x}set x(t){this.attrs.x=t}get y(){return this.attrs.y}set y(t){this.attrs.y=t}get width(){return this.attrs.width}set width(t){this.attrs.width=t}get height(){return this.attrs.height}set height(t){this.attrs.height=t}constructor(t){this.id=t.id||ft(),this.attrs={id:this.id,x:t.x,y:t.y,width:t.width,height:t.height,fill:t.fill||"#ff0000",stroke:t.stroke||"#000000",strokeWidth:t.strokeWidth||1,transform:t.transform||yt(),visible:t.visible!==!1}}hitTest(t){if(!this.attrs.visible)return!1;const e=this.getBounds();return t.x>=e.x&&t.x<=e.x+e.width&&t.y>=e.y&&t.y<=e.y+e.height}getBounds(){return{x:this.attrs.x,y:this.attrs.y,width:this.attrs.width,height:this.attrs.height}}getSize(){return{width:this.attrs.width,height:this.attrs.height}}updateAttrs(t){Object.assign(this.attrs,t)}getCenter(){return{x:this.attrs.x+this.attrs.width/2,y:this.attrs.y+this.attrs.height/2}}move(t,e){const s=this.attrs.x+t,i=this.attrs.y+e;this.updateAttrs({x:s,y:i}),this.attrs.transform&&(this.attrs.transform[4]=s,this.attrs.transform[5]=i)}setPosition(t,e){this.updateAttrs({x:t,y:e}),this.attrs.transform&&(this.attrs.transform[4]=t,this.attrs.transform[5]=e)}isVisible(){return this.attrs.visible!==!1}setVisible(t){this.updateAttrs({visible:t})}getWorldTransform(){return this.attrs.transform?[...this.attrs.transform]:[1,0,0,1,this.attrs.x||0,this.attrs.y||0]}}class R extends ct{constructor(t){super(t),this.type=W.Rectangle}draw(t){if(!this.attrs.visible)return;const{renderer:e}=t,{x:s,y:i,width:n,height:o,fill:a,stroke:h,strokeWidth:c}=this.attrs;e.save(),a&&(e.fillStyle=a,e.fillRect(s,i,n,o)),h&&c&&c>0&&(e.strokeStyle=h,e.lineWidth=c,e.strokeRect(s,i,n,o)),e.restore()}}function Tt(){return navigator.platform.indexOf("Win")>-1}const lt=r=>{const{ctrlKey:t=!1,shiftKey:e=!1,altKey:s=!1,metaKey:i=!1}=r;return`${t?"ctrl+":""}${i?"meta+":""}${e?"shift+":""}${s?"alt+":""}${r.code}`};class zt{constructor(t){this.editor=t,this.keyBindingMap=new Map,this.isBound=!1,this.id=0,this.handleAction=e=>{var n;if(e.altKey&&e.preventDefault(),e.target instanceof HTMLInputElement||e.target instanceof HTMLTextAreaElement)return;let s=!1;const i={isToolDragging:((n=this.editor.toolManager)==null?void 0:n.isDragging())||!1};for(const o of Array.from(this.keyBindingMap.values()))if((!o.when||o.when(i))&&(Tt()&&o.winKey?this.isKeyMatch(o.winKey,e)&&(s=!0):this.isKeyMatch(o.key,e)&&(s=!0)),s){e.preventDefault(),console.log(`[${lt(e)}] => ${o.actionName}`),o.action(e);break}s||console.log(`[${lt(e)}] => no match`)}}isKeyMatch(t,e){if(Array.isArray(t))return t.some(a=>this.isKeyMatch(a,e));if(t.keyCode=="*")return!0;const{ctrlKey:s=!1,shiftKey:i=!1,altKey:n=!1,metaKey:o=!1}=t;return s==e.ctrlKey&&i==e.shiftKey&&n==e.altKey&&o==e.metaKey&&t.keyCode==e.code}register(t){const e=this.id;return this.keyBindingMap.set(e,t),this.id++,e}registerWithHighPrior(t){const e=this.id,s=new Map;s.set(e,t);for(const[i,n]of Array.from(this.keyBindingMap))s.set(i,n);return this.keyBindingMap=s,this.id++,e}unregister(t){this.keyBindingMap.delete(t)}bindEvent(){this.isBound||(this.isBound=!0,document.addEventListener("keydown",this.handleAction))}destroy(){this.isBound&&(this.keyBindingMap.clear(),document.removeEventListener("keydown",this.handleAction))}}function At(){}function Wt(){let r=0;return()=>(++r).toString()}class Ht{constructor(t){this.editor=t,this.unbindEvents=At,this.hasBindEvents=!1}bindEvents(){if(this.hasBindEvents){console.log("ClipboardManager has bind events, please destroy first");return}this.hasBindEvents=!0;const t=()=>{this.copy()},e=s=>{const n=s.clipboardData;if(!n||s.target instanceof HTMLInputElement||s.target instanceof HTMLTextAreaElement)return;if(n.files.length>0){for(const a of Array.from(n.files))if(a.type.includes("image")){const h=new FileReader;h.onload=c=>{var f;const l=(f=c.target)==null?void 0:f.result;this.createGraphicsWithImg(l)},h.readAsDataURL(a)}return}const o=n.getData("Text");this.addGraphsFromClipboard(o)};this.editor.keybindingManager.register({key:{metaKey:!0,keyCode:"KeyC"},winKey:{ctrlKey:!0,keyCode:"KeyC"},actionName:"Copy",action:t}),window.addEventListener("paste",e),this.unbindEvents=()=>{window.removeEventListener("paste",e)}}async createGraphicsWithImg(t){console.log("Creating graphics with image:",t)}copy(){const t=this.getSelectedItemsSnapshot();t&&navigator.clipboard.writeText(t).then(()=>{console.log("copied")})}pasteAt(t){navigator.clipboard.readText().then(e=>{this.addGraphsFromClipboard(e,t)})}getSelectedItemsSnapshot(){const t=this.editor.getSelectionManager().getSelectedItems();if(t.length===0)return null;const e=Wt(),s=[];for(const i of t){const n={id:e(),type:i.type||"rectangle",x:i.x||0,y:i.y||0,width:i.width||100,height:i.height||100};s.push(n)}return JSON.stringify({appVersion:"koiot-editor-0.1.0",paperId:"koiot-paper",data:s})}addGraphsFromClipboard(t,e){let s=null;try{s=JSON.parse(t)}catch{console.log("Could not parse clipboard data, might be text:",t);return}if(!(s&&typeof s=="object"&&s.appVersion.startsWith("koiot-editor")&&s.data)){console.log("Invalid clipboard data format");return}if(s.data.length!==0){for(const i of s.data)console.log("Creating graphics from clipboard data:",i);console.log("Pasted",s.data.length,"items")}}destroy(){this.hasBindEvents=!1,this.unbindEvents()}}class Kt{constructor(){this.listeners=new Map}on(t,e){this.listeners.has(t)||this.listeners.set(t,new Set),this.listeners.get(t).add(e)}off(t,e){const s=this.listeners.get(t);s&&(s.delete(e),s.size===0&&this.listeners.delete(t))}emit(t,...e){const s=this.listeners.get(t);s&&s.forEach(i=>{try{i(...e)}catch(n){console.error(`Error in event listener for "${String(t)}":`,n)}})}removeAllListeners(){this.listeners.clear()}}class Dt{constructor(t){this.editor=t,this.redoStack=[],this.undoStack=[],this.isEnableRedoUndo=!0,this.emitter=new Kt,this.isBatching=!1}redo(){var t,e;if(this.isEnableRedoUndo&&this.redoStack.length>0){const s=this.redoStack.pop(),i=s.isBatched,n=[s];if(i){for(;this.redoStack.length>0&&this.redoStack.at(-1).isBatched;){const o=this.redoStack.pop();n.push(o)}console.log("------- [redo] batched start -----")}for(const o of n){const a=o.command;console.log(`%c Redo %c [${a.desc}]`,"background: #f04; color: #ee0",""),this.undoStack.push(o),(e=(t=o.hooks)==null?void 0:t.beforeRedo)==null||e.call(t),a.redo()}i&&console.log("------- [redo] batched end -----"),this.editor.render(),this.emitStatusChange()}}undo(){var t,e;if(this.isEnableRedoUndo&&this.undoStack.length>0){const s=this.undoStack.pop(),i=s.isBatched,n=[s];if(i){for(;this.undoStack.length>0&&this.undoStack.at(-1).isBatched;){const o=this.undoStack.pop();n.push(o)}console.log("------- [undo] batched start -----")}for(const o of n){const a=o.command;console.log(`%c Undo %c [${a.desc}]`,"background: #40f; color: #eee",""),this.redoStack.push(o),(e=(t=o.hooks)==null?void 0:t.beforeUndo)==null||e.call(t),a.undo()}i&&console.log("------- [undo] batched end -----"),this.editor.render(),this.emitStatusChange()}}enableRedoUndo(){this.isEnableRedoUndo=!0}disableRedoUndo(){this.isEnableRedoUndo=!1}batchCommandStart(){this.isBatching=!0}batchCommandEnd(){this.isBatching=!1}pushCommand(t,e){this.emitter.emit("beforeExecCmd"),console.log(`%c Exec %c [${t.desc}]`,"background: #222; color: #bada55","");const s={command:t};this.isBatching&&(s.isBatched=!0),e&&(s.hooks=e),this.undoStack.push(s),this.redoStack=[],this.emitStatusChange()}emitStatusChange(){this.emitter.emit("change",{canRedo:this.redoStack.length>0,canUndo:this.undoStack.length>0})}on(t,e){this.emitter.on(t,e)}off(t,e){this.emitter.off(t,e)}clearRecords(){this.redoStack=[],this.undoStack=[],this.emitStatusChange()}}class Yt{constructor(t){this.editor=t,this.isBound=!1}bindKey(){if(this.isBound){console.warn("CommandKeyBinding has been bound, please destroy it first");return}this.isBound=!0;const t=this.editor,e=()=>t.commandManager.undo();t.keybindingManager.register({key:{metaKey:!0,keyCode:"KeyZ"},winKey:{ctrlKey:!0,keyCode:"KeyZ"},when:h=>!h.isToolDragging,actionName:"Undo",action:e});const s=()=>t.commandManager.redo();t.keybindingManager.register({key:{metaKey:!0,shiftKey:!0,keyCode:"KeyZ"},winKey:{ctrlKey:!0,shiftKey:!0,keyCode:"KeyZ"},when:h=>!h.isToolDragging,actionName:"Redo",action:s});const i=()=>{console.log("Delete action triggered")};t.keybindingManager.register({key:[{keyCode:"Backspace"},{keyCode:"Delete"}],when:h=>!h.isToolDragging,actionName:"Delete",action:i});const n=()=>{console.log("Select all action triggered"),t.render()};t.keybindingManager.register({key:{metaKey:!0,keyCode:"KeyA"},winKey:{ctrlKey:!0,keyCode:"KeyA"},actionName:"Select All",action:n});const o=()=>{console.log("Duplicate action triggered"),t.clipboard.copy(),setTimeout(()=>{t.clipboard.pasteAt({x:10,y:10})},10)};t.keybindingManager.register({key:{metaKey:!0,keyCode:"KeyD"},winKey:{ctrlKey:!0,keyCode:"KeyD"},actionName:"Duplicate",action:o});const a=()=>{var h;((h=this.editor.toolManager.getActiveTool())==null?void 0:h.name)==="select"?t.getSelectionManager().clearSelection():this.editor.toolManager.setActiveTool("select"),t.render()};t.keybindingManager.register({key:{keyCode:"Escape"},actionName:"Escape",action:a})}destroy(){this.isBound=!1}}class Xt{constructor(t){this.eventEmitter=new v,this.isInitialized=!1,this.renderer=null,this.selectionBox=null,this.render=Y(()=>{if(!this.renderer)return;const e=this.viewportManager.getViewport(),s=this.zoomManager.getZoom(),i=D();this.renderer.clearBackground("#ffffff",e.width,e.height),this.renderer.save(),this.renderer.scale(i,i),this.renderer.scale(s,s),this.renderer.translate(-e.x,-e.y);const n=this.sceneManager.getAllGraphics();for(const o of n)o.isVisible()&&o.draw({renderer:this.renderer});this.renderer.restore(),this.renderer.save(),this.renderer.scale(i,i),this.drawSelectionBox(),this.drawSelectionIndicators(),this.renderer.restore(),this.renderer.flush()}),this.container=t.container,this.canvas=this.createCanvas(),this.viewportManager=new L(this.canvas),this.zoomManager=new V(this.viewportManager),this.selectionManager=new N,this.sceneManager=new Z,this.hostEventManager=new q(this.canvas),this.keybindingManager=new zt(this),this.keybindingManager.bindEvent(),this.clipboard=new Ht(this),this.clipboard.bindEvents(),this.commandManager=new Dt(this),this.commandKeyBinding=new Yt(this),this.commandKeyBinding.bindKey(),this.canvasDragger=new O(this.canvas,this.viewportManager,this.zoomManager,this.hostEventManager),this.selectedBoxManager=new G(this.selectionManager),this.controlHandleManager=new it(this.selectionManager,this.viewportManager,this.zoomManager,this.selectedBoxManager),this.toolManager=new nt(this.canvas,this.hostEventManager),this.selectTool=new ht({sceneManager:this.sceneManager,selectionManager:this.selectionManager,viewportManager:this.viewportManager,zoomManager:this.zoomManager,requestRender:()=>this.render(),toScenePt:(e,s)=>this.toScenePt(e,s),getCursorXY:e=>this.getCursorXY(e),getSceneCursorXY:e=>this.getSceneCursorXY(e),setSelectionBox:e=>this.setSelectionBox(e),clearSelectionBox:()=>this.clearSelectionBox(),selectedBoxManager:()=>this.selectedBoxManager,controlHandleManager:()=>this.controlHandleManager}),this.setupTools(),this.bindEvents(),this.initializeRenderer(t.canvasKitConfig)}createCanvas(){const t=document.createElement("canvas");return t.id="koiot-canvas",t.style.width="100%",t.style.height="100%",this.container.appendChild(t),t}setupTools(){this.toolManager.registerTool(this.selectTool),this.toolManager.setActiveTool("select")}bindEvents(){new ResizeObserver(()=>{this.viewportManager.updateSize(),this.render()}).observe(this.container),this.canvas.addEventListener("wheel",e=>{this.zoomManager.handleWheel(e)}),this.viewportManager.on("change",()=>this.render()),this.zoomManager.on("change",()=>this.render()),this.selectionManager.on("change",()=>this.render()),this.sceneManager.on("change",()=>this.render()),this.selectedBoxManager.on("boundsChange",()=>this.render()),this.selectedBoxManager.on("hoverChange",()=>this.render())}async initializeRenderer(t){try{this.renderer=await P.createRenderer(this.canvas,t)}catch(e){console.warn("CanvasKit failed, falling back to Canvas2D:",e),this.renderer=new F(this.canvas)}this.renderer&&(this.sceneManager.setRenderer(this.renderer),this.createInitialContent(),this.isInitialized=!0,this.eventEmitter.emit("ready"),this.render())}createInitialContent(){const t=new R({x:50,y:50,width:100,height:100,fill:"#ff0000",stroke:"#000000",strokeWidth:2}),e=new R({x:200,y:100,width:80,height:80,fill:"#00ff00",stroke:"#000000",strokeWidth:2}),s=new R({x:100,y:200,width:120,height:60,fill:"#0000ff",stroke:"#000000",strokeWidth:2});this.sceneManager.addGraphics(t),this.sceneManager.addGraphics(e),this.sceneManager.addGraphics(s)}drawSelectionIndicators(){if(!this.renderer||this.selectionManager.getSelectedItems().length===0)return;this.renderer.save();const e=this.zoomManager.getZoom(),s=this.viewportManager.getViewport();this.renderer.scale(e,e),this.renderer.translate(-s.x,-s.y),this.selectedBoxManager.draw(this.renderer),this.controlHandleManager.draw({renderer:this.renderer}),this.renderer.restore()}toScenePt(t,e){const s=this.zoomManager.getZoom(),i=this.viewportManager.getViewport();return X(t,e,s,i.x,i.y)}getCursorXY(t){const e=this.canvas.getBoundingClientRect();return{x:t.clientX-e.left,y:t.clientY-e.top}}getSceneCursorXY(t){const{x:e,y:s}=this.getCursorXY(t);return this.toScenePt(e,s)}toViewportPt(t,e){const s=this.zoomManager.getZoom(),i=this.viewportManager.getViewport();return mt(t,e,s,i.x,i.y)}setSelectionBox(t){this.selectionBox=t}clearSelectionBox(){this.selectionBox=null}drawSelectionBox(){if(!this.renderer||!this.selectionBox)return;const{x:t,y:e,width:s,height:i}=this.selectionBox,n=this.toViewportPt(t,e),o=this.toViewportPt(t+s,e+i),a={x:n.x,y:n.y,width:o.x-n.x,height:o.y-n.y};this.renderer.save(),this.renderer.fillStyle="rgba(0, 123, 255, 0.1)",this.renderer.fillRect(a.x,a.y,a.width,a.height),this.renderer.strokeStyle="#007fff",this.renderer.lineWidth=1,this.renderer.strokeRect(a.x,a.y,a.width,a.height),this.renderer.restore()}isReady(){return this.isInitialized}getSelectionManager(){return this.selectionManager}getSelectedBoxManager(){return this.selectedBoxManager}getControlHandleManager(){return this.controlHandleManager}getViewportManager(){return this.viewportManager}getZoomManager(){return this.zoomManager}getSceneManager(){return this.sceneManager}destroy(){this.toolManager.destroy(),this.selectedBoxManager.destroy(),this.controlHandleManager.destroy(),this.keybindingManager.destroy(),this.clipboard.destroy(),this.commandKeyBinding.destroy(),this.renderer&&this.renderer.destroy&&this.renderer.destroy(),this.canvas.remove(),this.eventEmitter.emit("destroy")}on(t,e){this.eventEmitter.on(t,e)}off(t,e){this.eventEmitter.off(t,e)}}g.BaseGraphics=ct,g.BoxSelectTool=Bt,g.Canvas2DRenderer=F,g.CanvasDragger=O,g.CanvasKitFactory=P,g.CanvasKitRenderer=_,g.ControlHandleManager=it,g.DrawSelection=ot,g.GraphicsType=W,g.HostEventManager=q,g.KoiotEditor=Xt,g.Rectangle=R,g.SceneManager=Z,g.SelectMoveTool=rt,g.SelectTool=ht,g.SelectedBoxManager=G,g.SelectionManager=N,g.ToolManager=nt,g.ViewportManager=L,g.ZoomManager=V,Object.defineProperty(g,Symbol.toStringTag,{value:"Module"})});
